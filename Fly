local RunService = game:GetService("RunService")

local Main = {}

local Main = {
    _flying = false,
    _vehicleFlying = false,
    _keys = {a=false, d=false, w=false, s=false},
    _torso = nil,
    _keyDownConnection = nil,
    _keyUpConnection = nil
}

Main.Configuration = {
    Fly = false,        
    SpeedFly = 7.5,     
    KeyFly = "x",      
    
    VehicleFly = false, 
    SpeedVehicleFly = 250, 
    KeyVehicleFly = "e" 
}

function Main.Load()
    local plr = game.Players.LocalPlayer
    local mouse = plr:GetMouse()
    local localplayer = plr

local function setupTorso()
    if workspace:FindFirstChild("Core") then
        workspace.Core:Destroy()
        Main._torso = Core
    end

    local Core = Instance.new("Part")
    Core.Name = "Core"
    Core.Size = Vector3.new(0.05, 0.05, 0.05)
    
    Core.Parent = workspace
    local Weld = Instance.new("Weld", Core)
    Weld.Part0 = Core
    local torsoName = "HumanoidRootPart"
    
    if localplayer.Character:FindFirstChild("Torso") then
        torsoName = "Torso"
    elseif localplayer.Character:FindFirstChild("UpperTorso") then
        torsoName = "UpperTorso"
    elseif localplayer.Character:FindFirstChild("LowerTorso") then
        torsoName = "LowerTorso"
    end
    
    Weld.Part1 = localplayer.Character:WaitForChild(torsoName)
    Weld.C0 = CFrame.new(0, 0, 0)
    torso = Core
end

    local function stop()
        Main._flying = false
        Main.Configuration.Fly = false
    end


    local function start()
        if not Main._torso then return end
        Main._flying = true
        local pos = Instance.new("BodyPosition", Main._torso)
        local gyro = Instance.new("BodyGyro", Main._torso)
        pos.Name = "EPIXPOS"
        pos.maxForce = Vector3.new(math.huge, math.huge, math.huge)
        pos.position = Main._torso.Position
    gyro.maxTorque = Vector3.new(9e9, 9e9, 9e9)
    gyro.cframe = torso.CFrame
    
    repeat
        RunService.Heartbeat:Wait()
        localplayer.Character.Humanoid.PlatformStand = true
        local new = gyro.cframe - gyro.cframe.p + pos.position
        
        if keys.w then
            new = new + workspace.CurrentCamera.CFrame.lookVector * Main.Configuration.SpeedFly
        end
        if keys.s then
            new = new - workspace.CurrentCamera.CFrame.lookVector * Main.Configuration.SpeedFly
        end
        if keys.d then
            new = new * CFrame.new(Main.Configuration.SpeedFly, 0, 0)
        end
        if keys.a then
            new = new * CFrame.new(-Main.Configuration.SpeedFly, 0, 0)
        end
        
        pos.position = new.p
        gyro.cframe = workspace.CurrentCamera.CFrame
    until not Main.Configuration.Fly

    gyro:Destroy()
    pos:Destroy()
    localplayer.Character.Humanoid.PlatformStand = false
end

local function startVehicleFly()
    local seat = plr.Character and plr.Character.Humanoid.SeatPart
    if not seat then return end

    local bg = Instance.new("BodyGyro", seat)
    bg.P = 9e4
    bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.cframe = seat.CFrame

    local bv = Instance.new("BodyVelocity", seat)
    bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
    bv.velocity = Vector3.new(0, 0, 0)

    vehicleFlying = true
    repeat
        RunService.Heartbeat:Wait()
        local moveVector = (workspace.CurrentCamera.CFrame.lookVector * (keys.w and 1 or keys.s and -1 or 0))
            + ((workspace.CurrentCamera.CFrame * CFrame.new((keys.a and -1 or keys.d and 1 or 0), 0, 0).p)
            - workspace.CurrentCamera.CFrame.p)
        bv.velocity = moveVector * Main.Configuration.SpeedVehicleFly
        bg.CFrame = seat.CFrame
    until not Main.Configuration.VehicleFly

    bg:Destroy()
    bv:Destroy()
    vehicleFlying = false
end

local function toggleVehicleFly()
    Main.Configuration.VehicleFly = not Main.Configuration.VehicleFly
    if Main.Configuration.VehicleFly then
        startVehicleFly()
    end
end

local function resetKeyEvents()
        if Main._keyDownConnection then Main._keyDownConnection:Disconnect() end
        if Main._keyUpConnection then Main._keyUpConnection:Disconnect() end

        Main._keyDownConnection = mouse.KeyDown:Connect(function(key)
            if key:lower() == "w" then Main._keys.w = true end
            if key:lower() == "s" then Main._keys.s = true end
            if key:lower() == "a" then Main._keys.a = true end
            if key:lower() == "d" then Main._keys.d = true end
        
        if key:lower() == Main.Configuration.KeyFly:lower() then
            Main.Configuration.Fly = not Main.Configuration.Fly
            if Main.Configuration.Fly then
                start()
            else
                stop()
            end
        end
        
        if key:lower() == Main.Configuration.KeyVehicleFly:lower() then
            toggleVehicleFly()
        end
    end)

   Main._keyUpConnection = mouse.KeyUp:Connect(function(key)
            if key:lower() == "w" then Main._keys.w = false end
            if key:lower() == "s" then Main._keys.s = false end
            if key:lower() == "a" then Main._keys.a = false end
            if key:lower() == "d" then Main._keys.d = false end
        end)
    end

    plr.CharacterAdded:Connect(function()
        wait(1)
        setupTorso()
        resetKeyEvents()
        if Main.Configuration.Fly then
            start()
        end
    end)

    setupTorso()
    resetKeyEvents()
end

return Main
